---
import { Image } from "astro:assets";
import maatLogo from "@assets/companies/maat.png";
import marshLogo from "@assets/companies/marsh.jpg";

interface Props {
  company: string;
  url?: string;
  description?: string;
  logo?: string;
}

const { company, url, description, logo } = Astro.props;

const logos: Record<string, ImageMetadata> = {
  maat: maatLogo,
  marsh: marshLogo,
};

const logoImage = logo ? logos[logo] : undefined;
const instanceId = `company-card-${Math.random().toString(36).slice(2, 8)}`;
---

<span class="company-card-trigger inline" data-instance={instanceId}>
  <slot />
</span>

<template id={`${instanceId}-template`}>
  <div
    role="tooltip"
    class="company-card pointer-events-none fixed z-50 w-72 rounded-lg border border-cloud-medium/30 dark:border-cloud-medium/40 bg-ivory-light dark:bg-slate-medium shadow-lg opacity-0 translate-y-1"
    data-instance={instanceId}
    style="top: -9999px; left: -9999px; transition: opacity 200ms ease-out, transform 200ms ease-out;"
  >
    <div class="p-4 flex flex-col gap-3">
      {logoImage && (
        <Image
          src={logoImage}
          alt={`${company} logo`}
          width={48}
          height={48}
          class="rounded-md size-12 object-contain ring-1 ring-cloud-medium/30 dark:ring-cloud-medium/40"
        />
      )}
      <div class="flex flex-wrap items-baseline gap-x-1.5 gap-y-0.5 min-w-0">
        <span class="font-semibold text-sm text-slate-dark dark:text-ivory-light">{company}</span>
        {url && (
          <span class="text-xs text-cloud-dark dark:text-cloud-light font-normal">
            {new URL(url).hostname}
          </span>
        )}
      </div>
      {description && (
        <p class="text-xs text-slate-dark/75 dark:text-ivory-light/75 leading-relaxed !m-0 !p-0 font-sans">
          {description}
        </p>
      )}
    </div>
  </div>
</template>

<script>
  function positionCard(trigger: Element, card: HTMLElement) {
    const rect = trigger.getBoundingClientRect();
    const cardHeight = card.offsetHeight || 140;
    const spaceAbove = rect.top;

    if (spaceAbove < cardHeight + 16) {
      card.style.top = `${rect.bottom + 8}px`;
    } else {
      card.style.top = `${rect.top - cardHeight - 8}px`;
    }

    const left = Math.min(rect.left, window.innerWidth - 288 - 16);
    card.style.left = `${left}px`;
  }

  function initCompanyCards() {
    const triggers = document.querySelectorAll<HTMLElement>(".company-card-trigger[data-instance]");

    triggers.forEach((trigger) => {
      const instanceId = trigger.dataset.instance;
      if (!instanceId) return;

      const template = document.getElementById(`${instanceId}-template`) as HTMLTemplateElement | null;
      if (!template) return;

      document.querySelector(`.company-card[data-instance="${instanceId}"]`)?.remove();

      const fragment = template.content.cloneNode(true) as DocumentFragment;
      document.body.appendChild(fragment);
      const cardEl = document.querySelector<HTMLElement>(`.company-card[data-instance="${instanceId}"]`);
      if (!cardEl) return;

      let hideTimeout: ReturnType<typeof setTimeout>;

      function show() {
        clearTimeout(hideTimeout);
        positionCard(trigger, cardEl!);
        cardEl!.getBoundingClientRect();
        cardEl!.classList.remove("opacity-0", "translate-y-1", "pointer-events-none");
        cardEl!.classList.add("opacity-100", "translate-y-0", "pointer-events-auto");
      }

      function hide() {
        hideTimeout = setTimeout(() => {
          cardEl!.classList.remove("opacity-100", "translate-y-0", "pointer-events-auto");
          cardEl!.classList.add("opacity-0", "translate-y-1", "pointer-events-none");
        }, 100);
      }

      trigger.addEventListener("mouseenter", show);
      trigger.addEventListener("mouseleave", hide);
      cardEl.addEventListener("mouseenter", () => clearTimeout(hideTimeout));
      cardEl.addEventListener("mouseleave", hide);
    });
  }

  document.addEventListener("DOMContentLoaded", initCompanyCards);
  document.addEventListener("astro:after-swap", initCompanyCards);
</script>

---
import { type CollectionEntry, getCollection, render } from "astro:content";
import ArrowCard from "@components/ArrowCard.astro";
import BackToPrev from "@components/BackToPrev.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import TableOfContents from "@components/TableOfContents.astro";
import TagList from "@components/TagList.astro";
import PageLayout from "@layouts/PageLayout.astro";
import { getContentByTag, normalizeEntryId, readingTime } from "@lib/utils";

export async function getStaticPaths() {
  const posts = (await getCollection("blog"))
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  return posts.map((post) => ({
    params: { slug: normalizeEntryId(post) },
    props: post,
  }));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content, headings } = await render(post);

// Get related content based on first tag
const allBlog = await getCollection("blog", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allProjects = await getCollection("projects", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allWork = await getCollection("work");

const relatedContent =
  post.data.tags && post.data.tags.length > 0
    ? getContentByTag(post.data.tags[0], allBlog, allProjects, allWork)
        .filter(
          (item) => normalizeEntryId(item.entry) !== normalizeEntryId(post),
        )
        .slice(0, 3)
    : [];
---

<PageLayout title={post.data.title} description={post.data.description}>
  <Container>
    <div class="animate">
      <BackToPrev href="/blog">
        Back to blog
      </BackToPrev>
    </div>
    <div class="space-y-1 my-10">
      <div class="animate flex items-center gap-1.5">
        <div class="font-base text-sm">
          <FormattedDate date={post.data.date} />
        </div>
        &bull;
        <div class="font-base text-sm">
          {readingTime(post.body ?? "")}
        </div>
      </div>
      <div class="animate text-2xl font-semibold text-slate-dark dark:text-ivory-light">
        {post.data.title}
      </div>
      <div class="animate text-cloud-dark dark:text-cloud-light">
        {post.data.description}
      </div>
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="animate">
          <TagList tags={post.data.tags} class="mt-3" />
        </div>
      )}
    </div>
    <div class="animate">
      <TableOfContents headings={headings} />
    </div>
    <article class="animate">
      <Content />
    </article>

    {relatedContent.length > 0 && (
      <div class="mt-12">
        <p class="animate text-xs uppercase tracking-widest text-cloud-dark dark:text-cloud-light mb-3">
          Related
        </p>
        <ul class="animate flex flex-col">
          {relatedContent.map((item) => {
            if (item.type === "blog" || item.type === "project") {
              return (
                <li>
                  <ArrowCard entry={item.entry as any} />
                </li>
              );
            } else {
              const workEntry = item.entry as any;
              return (
                <li>
                  <a
                    href={`/work#${workEntry.id.split("/")[0]}`}
                    data-hover-row
                    class="relative grid grid-cols-[4rem_1fr_auto] gap-x-4 items-baseline py-2 px-2 border-b border-cloud-medium/10 dark:border-cloud-medium/5"
                  >
                    <span class="text-xs text-cloud-dark dark:text-cloud-light tabular-nums">
                      work
                    </span>
                    <div class="min-w-0">
                      <div class="text-sm font-medium truncate">{workEntry.data.role}</div>
                      {workEntry.data.description && (
                        <div class="text-xs text-cloud-dark dark:text-cloud-light truncate mt-0.5">
                          {workEntry.data.description}
                        </div>
                      )}
                    </div>
                  </a>
                </li>
              );
            }
          })}
        </ul>
      </div>
    )}
  </Container>
</PageLayout>
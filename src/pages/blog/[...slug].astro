---
import { type CollectionEntry, getCollection, render } from "astro:content";
import ArrowCard from "@components/ArrowCard.astro";
import BackToPrev from "@components/BackToPrev.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import TableOfContents from "@components/TableOfContents.astro";
import TagList from "@components/TagList.astro";
import PageLayout from "@layouts/PageLayout.astro";
import { getContentByTag, normalizeEntryId, readingTime } from "@lib/utils";

export async function getStaticPaths() {
  const posts = (await getCollection("blog"))
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  return posts.map((post) => ({
    params: { slug: normalizeEntryId(post) },
    props: post,
  }));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content, headings } = await render(post);

// Get related content based on first tag
const allBlog = await getCollection("blog", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allProjects = await getCollection("projects", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allWork = await getCollection("work");

const relatedContent =
  post.data.tags && post.data.tags.length > 0
    ? getContentByTag(post.data.tags[0], allBlog, allProjects, allWork)
        .filter(
          (item) => normalizeEntryId(item.entry) !== normalizeEntryId(post),
        )
        .slice(0, 3)
    : [];
---

<PageLayout title={post.data.title} description={post.data.description}>
  <Container>
    <div class="animate">
      <BackToPrev href="/blog">
        Back to blog
      </BackToPrev>
    </div>
    <div class="space-y-1 my-10">
      <div class="animate flex items-center gap-1.5">
        <div class="font-base text-sm">
          <FormattedDate date={post.data.date} />
        </div>
        &bull;
        <div class="font-base text-sm">
          {readingTime(post.body ?? "")}
        </div>
      </div>
      <div class="animate text-2xl font-semibold text-slate-dark dark:text-ivory-light">
        {post.data.title}
      </div>
      <div class="animate text-cloud-dark dark:text-cloud-light">
        {post.data.description}
      </div>
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="animate">
          <TagList tags={post.data.tags} class="mt-3" />
        </div>
      )}
    </div>
    <div class="animate">
      <TableOfContents headings={headings} />
    </div>
    <article class="animate">
      <Content />
    </article>

    {relatedContent.length > 0 && (
      <div class="mt-16 space-y-4">
        <h2 class="animate text-lg font-semibold text-slate-dark dark:text-ivory-light">
          Related Content
        </h2>
        <ul class="animate flex flex-col gap-4">
          {relatedContent.map((item) => {
            if (item.type === "blog") {
              return (
                <li>
                  <ArrowCard entry={item.entry as any} />
                </li>
              );
            } else if (item.type === "project") {
              return (
                <li>
                  <ArrowCard entry={item.entry as any} />
                </li>
              );
            } else {
              // Work position
              const workEntry = item.entry as any;
              return (
                <li>
                  <a
                    href={`/work#${workEntry.id.split("/")[0]}`}
                    class="relative group flex flex-nowrap py-3 px-4 pr-10 rounded-lg border border-cloud-medium/30 dark:border-cloud-medium/40 hover:bg-cloud-dark/5 dark:hover:bg-ivory-dark/5 hover:text-slate-dark dark:hover:text-ivory-light transition-colors duration-300 ease-in-out"
                  >
                    <div class="flex flex-col flex-1 truncate">
                      <div class="font-semibold">{workEntry.data.role}</div>
                      <div class="text-sm text-cloud-dark dark:text-cloud-light">
                        {workEntry.data.description}
                      </div>
                    </div>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      class="absolute top-1/2 right-2 -translate-y-1/2 size-5 stroke-2 fill-none stroke-current"
                    >
                      <line
                        x1="5"
                        y1="12"
                        x2="19"
                        y2="12"
                        class="translate-x-3 group-hover:translate-x-0 scale-x-0 group-hover:scale-x-100 transition-transform duration-300 ease-in-out"
                      />
                      <polyline
                        points="12 5 19 12 12 19"
                        class="-translate-x-1 group-hover:translate-x-0 transition-transform duration-300 ease-in-out"
                      />
                    </svg>
                  </a>
                </li>
              );
            }
          })}
        </ul>
      </div>
    )}
  </Container>
</PageLayout>
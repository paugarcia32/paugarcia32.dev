---
import { getCollection } from "astro:content";
import Container from "@components/Container.astro";
import Link from "@components/Link.astro";
import PageLayout from "@layouts/PageLayout.astro";
import { dateRange, formatDate, getAllTags, getContentByTag } from "@lib/utils";
import type { GetStaticPaths } from "astro";

export const getStaticPaths = (async () => {
  const blogPosts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  const projects = await getCollection("projects", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  const allWork = await getCollection("work");

  const allTags = getAllTags(blogPosts, projects, allWork);

  return Array.from(allTags.entries()).map(([slug, displayName]) => ({
    params: { tag: slug },
    props: { tag: displayName, slug, blogPosts, projects, allWork },
  }));
}) satisfies GetStaticPaths;

const { tag, blogPosts, projects, allWork } = Astro.props;

const taggedContent = getContentByTag(tag, blogPosts, projects, allWork);
const blogContent = taggedContent.filter((item) => item.type === "blog");
const projectContent = taggedContent.filter((item) => item.type === "project");
const workContent = taggedContent.filter((item) => item.type === "work");
---

<PageLayout title={`${tag}`} description={`All content tagged with "${tag}"`}>
  <Container>
    <div class="space-y-10">
      <div class="animate space-y-1">
        <div class="font-semibold text-slate-dark dark:text-ivory-light">{tag}</div>
        <p class="text-sm text-cloud-dark dark:text-cloud-light">
          {taggedContent.length} item{taggedContent.length !== 1 ? "s" : ""}
        </p>
      </div>

      {blogContent.length > 0 && (
        <section class="animate space-y-3">
          <div class="text-xs font-medium text-cloud-dark dark:text-cloud-light uppercase tracking-wider">
            Blog
          </div>
          <div data-hover-table class="relative flex flex-col">
            <div data-hover-highlight class="pointer-events-none absolute left-0 right-0 rounded-md bg-cloud-medium/10 dark:bg-cloud-medium/10 opacity-0" style="height: 0px; top: 0px;"></div>
            {blogContent.map((item) => {
              const entry = item.entry as any;
              return (
                <a
                  href={`/blog/${entry.id}`}
                  data-hover-row
                  class="relative grid grid-cols-[4rem_1fr] gap-x-4 items-baseline py-2 px-2 border-b border-cloud-medium/10 dark:border-cloud-medium/5"
                >
                  <span class="text-xs text-cloud-dark dark:text-cloud-light tabular-nums">
                    {entry.data.date ? entry.data.date.getFullYear() : ""}
                  </span>
                  <span class="text-sm font-medium">{entry.data.title}</span>
                </a>
              );
            })}
          </div>
        </section>
      )}

      {projectContent.length > 0 && (
        <section class="animate space-y-3">
          <div class="text-xs font-medium text-cloud-dark dark:text-cloud-light uppercase tracking-wider">
            Projects
          </div>
          <div data-hover-table class="relative flex flex-col">
            <div data-hover-highlight class="pointer-events-none absolute left-0 right-0 rounded-md bg-cloud-medium/10 dark:bg-cloud-medium/10 opacity-0" style="height: 0px; top: 0px;"></div>
            {projectContent.map((item) => {
              const entry = item.entry as any;
              return (
                <a
                  href={`/projects/${entry.id}`}
                  data-hover-row
                  class="relative grid grid-cols-[4rem_1fr] gap-x-4 items-baseline py-2 px-2 border-b border-cloud-medium/10 dark:border-cloud-medium/5"
                >
                  <span class="text-xs text-cloud-dark dark:text-cloud-light tabular-nums">
                    {entry.data.date ? entry.data.date.getFullYear() : ""}
                  </span>
                  <span class="text-sm font-medium">{entry.data.title}</span>
                </a>
              );
            })}
          </div>
        </section>
      )}

      {workContent.length > 0 && (
        <section class="animate space-y-3">
          <div class="text-xs font-medium text-cloud-dark dark:text-cloud-light uppercase tracking-wider">
            Work
          </div>
          <div data-hover-table class="relative flex flex-col">
            <div data-hover-highlight class="pointer-events-none absolute left-0 right-0 rounded-md bg-cloud-medium/10 dark:bg-cloud-medium/10 opacity-0" style="height: 0px; top: 0px;"></div>
            {workContent.map((item) => {
              const position = item.entry as any;
              const companyFolder = position.id.split("/")[0];
              const companyEntry = allWork.find(
                (e) => e.id.startsWith(companyFolder + "/") && e.data.type === "company"
              );
              const companyName =
                companyEntry?.data.type === "company"
                  ? companyEntry.data.company
                  : companyFolder;
              return (
                <a
                  href="/work"
                  data-hover-row
                  class="relative grid grid-cols-[4rem_1fr_auto] gap-x-4 items-baseline py-2 px-2 border-b border-cloud-medium/10 dark:border-cloud-medium/5"
                >
                  <span class="text-xs text-cloud-dark dark:text-cloud-light tabular-nums">
                    {position.data.dateStart ? position.data.dateStart.getFullYear() : ""}
                  </span>
                  <span class="text-sm font-medium">{position.data.role}</span>
                  <span class="text-xs text-cloud-dark dark:text-cloud-light text-right">{companyName}</span>
                </a>
              );
            })}
          </div>
        </section>
      )}

      {taggedContent.length === 0 && (
        <div class="animate text-sm text-cloud-medium dark:text-cloud-medium">
          No content found with this tag.
        </div>
      )}
    </div>
  </Container>
</PageLayout>

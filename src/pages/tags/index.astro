---
import { getCollection } from "astro:content";
import Container from "@components/Container.astro";
import Link from "@components/Link.astro";
import PageLayout from "@layouts/PageLayout.astro";
import { getAllTags, getContentByTag } from "@lib/utils";

const blogPosts = await getCollection("blog", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const projects = await getCollection("projects", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allWork = await getCollection("work");

const allTags = getAllTags(blogPosts, projects, allWork);

const tagsWithMeta = Array.from(allTags.entries())
  .map(([slug, displayName]) => {
    const items = getContentByTag(displayName, blogPosts, projects, allWork);
    return { slug, displayName, count: items.length, lastUpdated: items[0]?.date };
  })
  .filter((t) => t.count > 0)
  .sort((a, b) => b.count - a.count);
---

<PageLayout title="Tags" description="Browse all content organized by tags.">
  <Container>
    <div class="space-y-10">
      <div class="animate space-y-1">
        <div class="font-semibold text-slate-dark dark:text-ivory-light">Topics</div>
        <p class="text-sm text-cloud-dark dark:text-cloud-light">
          {tagsWithMeta.length} topics across blog posts, projects, and work experience
        </p>
      </div>

      {tagsWithMeta.length > 0 ? (
        <div class="animate relative flex flex-col" data-hover-table>
          <div class="grid grid-cols-[4rem_1fr_auto] gap-x-4 border-b border-cloud-medium/20 dark:border-cloud-medium/10 pb-1.5 mb-1 px-2">
            <span class="text-xs text-cloud-dark dark:text-cloud-light">updated</span>
            <span class="text-xs text-cloud-dark dark:text-cloud-light">topic</span>
            <span class="text-xs text-cloud-dark dark:text-cloud-light text-right">items</span>
          </div>
          <div data-hover-highlight class="pointer-events-none absolute left-0 right-0 rounded-md bg-cloud-medium/10 dark:bg-cloud-medium/10 opacity-0" style="height: 0px; top: 0px;"></div>
          {tagsWithMeta.map(({ slug, displayName, count, lastUpdated }) => (
            <a
              href={`/tags/${slug}`}
              data-hover-row
              class="relative grid grid-cols-[4rem_1fr_auto] gap-x-4 items-baseline py-2 px-2 border-b border-cloud-medium/10 dark:border-cloud-medium/5"
            >
              <span class="text-xs text-cloud-dark dark:text-cloud-light tabular-nums">
                {lastUpdated ? lastUpdated.getFullYear() : ""}
              </span>
              <span class="text-sm font-medium">
                {displayName}
              </span>
              <span class="text-xs text-cloud-dark dark:text-cloud-light text-right tabular-nums">
                {count}
              </span>
            </a>
          ))}
        </div>
      ) : (
        <div class="animate text-cloud-medium dark:text-cloud-medium text-sm">
          No topics found.
        </div>
      )}
    </div>
  </Container>
</PageLayout>

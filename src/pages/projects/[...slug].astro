---
import { type CollectionEntry, getCollection, render } from "astro:content";
import ArrowCard from "@components/ArrowCard.astro";
import BackToPrev from "@components/BackToPrev.astro";
import Container from "@components/Container.astro";
import FormattedDate from "@components/FormattedDate.astro";
import Link from "@components/Link.astro";
import TagList from "@components/TagList.astro";
import PageLayout from "@layouts/PageLayout.astro";
import { getContentByTag, getWorkPositionById, normalizeEntryId, readingTime } from "@lib/utils";

export async function getStaticPaths() {
  const projects = (await getCollection("projects"))
    .filter((post) => !post.data.draft)
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  return projects.map((project) => ({
    params: { slug: normalizeEntryId(project) },
    props: project,
  }));
}
type Props = CollectionEntry<"projects">;

const project = Astro.props;
const { Content } = await render(project);

// Get related content based on first tag
const allBlog = await getCollection("blog", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allProjects = await getCollection("projects", ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});
const allWork = await getCollection("work");

const relatedContent =
  project.data.tags && project.data.tags.length > 0
    ? getContentByTag(project.data.tags[0], allBlog, allProjects, allWork)
        .filter(
          (item) => normalizeEntryId(item.entry) !== normalizeEntryId(project),
        )
        .slice(0, 3)
    : [];

const linkedPosition = project.data.workPosition
  ? getWorkPositionById(allWork, project.data.workPosition)
  : null;
---

<PageLayout title={project.data.title} description={project.data.description}>
  <Container>
    <div class="animate">
      <BackToPrev href="/projects">
        Back to projects
      </BackToPrev>
    </div>
    <div class="space-y-1 my-10">
      <div class="animate flex items-center gap-1.5">
        <div class="font-base text-sm">
          <FormattedDate date={project.data.date} />
        </div>
        &bull;
        <div class="font-base text-sm">
          {readingTime(project.body ?? "")}
        </div>
      </div>
      {linkedPosition && (
        <div class="animate flex items-center gap-1.5 text-xs text-cloud-dark dark:text-cloud-light mb-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="size-3.5 shrink-0">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 0 0 .75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 0 0-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0 1 12 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 0 1-.673-.38m0 0A2.18 2.18 0 0 1 3 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 0 1 3.413-.387m7.5 0V5.25A2.25 2.25 0 0 0 13.5 3h-3a2.25 2.25 0 0 0-2.25 2.25v.894m7.5 0a48.667 48.667 0 0 0-7.5 0M12 12.75h.008v.008H12v-.008Z" />
          </svg>
          <a
            href={`/work#${project.data.workPosition!.split("/")[0]}`}
            class="hover:text-slate-dark dark:hover:text-ivory-light hover:underline transition-colors"
          >
            {linkedPosition.companyName} Â· {linkedPosition.position.data.role}
          </a>
        </div>
      )}
      <div class="animate text-2xl font-semibold text-slate-dark dark:text-ivory-light">
        {project.data.title}
      </div>
      <div class="animate text-cloud-dark dark:text-cloud-light">
        {project.data.description}
      </div>
      {(project.data.demoURL || project.data.repoURL) && (
        <nav class="animate flex gap-1">
          {project.data.demoURL && (
            <Link href={project.data.demoURL} external>
              demo
            </Link>
          )}
          {project.data.demoURL && project.data.repoURL && (
            <span>/</span>
          )}
          {project.data.repoURL && (
            <Link href={project.data.repoURL} external>
              repo
            </Link>
          )}
        </nav>
      )}
      {project.data.tags && project.data.tags.length > 0 && (
        <div class="animate">
          <TagList tags={project.data.tags} class="mt-3" />
        </div>
      )}
    </div>
    <article class="animate">
      <Content />
    </article>

    {relatedContent.length > 0 && (
      <div class="mt-12">
        <p class="animate text-xs uppercase tracking-widest text-cloud-dark dark:text-cloud-light mb-3">
          Related
        </p>
        <ul class="animate flex flex-col">
          {relatedContent.map((item) => {
            if (item.type === "blog" || item.type === "project") {
              return (
                <li>
                  <ArrowCard entry={item.entry as any} />
                </li>
              );
            } else {
              const workEntry = item.entry as any;
              return (
                <li>
                  <a
                    href={`/work#${workEntry.id.split("/")[0]}`}
                    data-hover-row
                    class="relative grid grid-cols-[4rem_1fr_auto] gap-x-4 items-baseline py-2 px-2 border-b border-cloud-medium/10 dark:border-cloud-medium/5"
                  >
                    <span class="text-xs text-cloud-dark dark:text-cloud-light tabular-nums">
                      work
                    </span>
                    <div class="min-w-0">
                      <div class="text-sm font-medium truncate">{workEntry.data.role}</div>
                      {workEntry.data.description && (
                        <div class="text-xs text-cloud-dark dark:text-cloud-light truncate mt-0.5">
                          {workEntry.data.description}
                        </div>
                      )}
                    </div>
                  </a>
                </li>
              );
            }
          })}
        </ul>
      </div>
    )}
  </Container>
</PageLayout>